---
import BaseLayout from "./BaseLayout.astro";
const { frontmatter } = Astro.props;
const { headings = [] } = Astro.props;

import CryptoJS from "crypto-js";
const { AES, enc } = CryptoJS;

import PasswordPrompt from "../components/PasswordPrompt.jsx";

import BackToTop from "../components/BackToTop.astro";

// 1. 首先过滤出我们需要显示的标题 (h2, h3)
const filteredHeadings = headings.filter(
    (heading: any) => heading.depth > 1 && heading.depth < 4
);

// 创建一个格式化后的日期
const postDate = new Date(frontmatter.pubDate);
const formattedDate = postDate.toLocaleDateString("en-CA", {
    year: "numeric",
    month: "long",
    day: "numeric",
});

// 加密
const { encrypted, passwordKey } = frontmatter;
let encryptedContent = null;
let correctPassword = null;
// 使用.env + passwordKey 解密内容
if (encrypted && passwordKey) {
    correctPassword = import.meta.env[passwordKey];

    if (!correctPassword) {
        throw new Error(
            `Password for key ${passwordKey} is not set in environment variables.`
        );
    }

    // 预先渲染<slot />内容为加密文本
    const rawContent = await Astro.slots.render("default");
    encryptedContent = AES.encrypt(rawContent, correctPassword).toString();
}
---

<BaseLayout pageTitle={frontmatter.title}>
    <div class='post-layout-grid'>
        <header class='post-header'>
            <h1>{frontmatter.title}</h1>
            <div class='post-meta'>
                <span>Author: {frontmatter.author}</span>
                <time datetime={postDate.toISOString()}
                    >Publish: {formattedDate}</time
                >
            </div>
        </header>
        {/* 2. 只有当过滤后的标题数量大于 0 时，才渲染整个目录组件 */}
        {
            filteredHeadings.length > 0 && (
                <aside class='post-toc'>
                    <div class='toc-wrapper'>
                        {/* 3. 使用 <details> 和 <summary> 实现原生折叠功能 */}
                        {/* 添加 open 属性可以让目录默认展开 */}
                        <details open>
                            <summary>
                                <h3>目录</h3>
                            </summary>
                            <ul>
                                {filteredHeadings.map((heading: any) => (
                                    <li class={`depth-${heading.depth}`}>
                                        <a href={`#${heading.slug}`}>
                                            {heading.text}
                                        </a>
                                    </li>
                                ))}
                            </ul>
                        </details>
                    </div>
                </aside>
            )
        }

        <article
            class='post-content prose prose-slate dark:prose-invert mx-auto p-4'
        >
            {
                encrypted && encryptedContent && correctPassword ? (
                    <PasswordPrompt
                        client:only='react'
                        encryptedContent={encryptedContent}
                        correctPassword={correctPassword}
                    />
                ) : (
                    <slot />
                )
            }
        </article>
    </div>
</BaseLayout>

<style>
    /* --- 1. 整体布局 Grid --- */
    .post-layout-grid {
        display: grid;
        /* 定义列：主内容区 (占据大部分空间) 和 侧边栏 (固定宽度) */
        /* grid-template-columns: 1fr 280px; */
        grid-template-columns: 1fr;
        /* gap: 3rem; 两栏之间的间距 */
        gap: 0;
        /* align-items: start; */
        /* --- 或者，使用这一行代码 --- */
        align-items: baseline;

        /* [关键修复 1] 必须加这三行！让这一层 Grid 也能正确收缩 */
        width: 100%;
        max-width: 100%;
        min-width: 0;
    }

    /* --- 2. 文章头部样式 --- */
    .post-header {
        /* 让头部横跨两栏 */
        /* grid-column: 1 / -1; */
        padding-bottom: 2rem;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 0rem;
    }

    .post-header h1 {
        /* 继承全局 h1 样式，这里可以做微调 */
        margin-bottom: 1rem;
    }

    .post-meta {
        display: flex;
        gap: 1.5rem;
        font-size: 0.9rem;
        color: var(--secondary-text-color);
    }

    /* --- 3. 文章正文样式 --- */
    .post-content {
        /* 正文区的样式，例如行高、段落间距等 */
        line-height: 1.8;

        /* [关键修复 2] 强制约束 Article 的宽度 */
        /* 因为你用了 prose mx-auto，这里必须限制最大宽度为 100% */
        width: 100%;
        max-width: 100%;
        min-width: 0; /* 再次强调：允许收缩 */

        /* 额外保险：防止 padding 撑爆 (虽然全局应该有了，但这里加更稳) */
        box-sizing: border-box;
        overflow-x: hidden; /* 防止正文内的其他怪异元素溢出 */
    }

    /* 为正文中的标题、段落等元素设置统一样式 */
    .post-content > :global(h2),
    .post-content > :global(h3) {
        margin-top: 0rem;
        margin-bottom: 1rem;
    }

    .post-content > :global(p) {
        margin-bottom: 1.5rem;
    }

    /* 专门针对正文内的代码块进行最后一道防线加固 */
    .post-content :global(pre),
    .post-content :global(code) {
        white-space: pre-wrap; /* 允许换行，或者保留 pre */
        word-break: break-all; /* 强制打断长单词 */
        max-width: 100%; /* 绝不许超过父容器 */
        overflow-x: auto; /* 允许滚动 */
    }

    /* --- 4. 目录 (TOC) 样式 --- */
    /* .post-toc {
        /* 继承全局 .table-of-contents 的部分样式，但这里做定位 */
    /* } */

    .post-toc {
        border: 1px solid var(--border-color);
        padding: 1rem 1.5rem;
        /* border-radius: 8px; 圆角 */
        border-radius: 2px;
        /* border-radius: 0; */
        margin-top: 2.5rem;
        margin-bottom: 2.5rem; /* 与下方文章内容的间距 */
        background-color: var(
            --primary-fill-color
        ); /* 可选：加个淡淡的背景色 */
    }

    /* 为 <summary> 添加一个鼠标指针样式，提示用户可以点击 */
    .post-toc summary {
        cursor: pointer;
        /* 防止点击时出现浏览器默认的轮廓线 */
        outline: none;
    }

    /* 默认的展开/收起小三角可能不好看，可以自定义样式或隐藏它 */
    .post-toc summary::-webkit-details-marker {
        /* display: none; */ /* 如果想完全隐藏，取消这行注释 */
    }

    .post-toc h3 {
        /* 让 "目录" 标题和折叠三角在同一行显示 */
        display: inline-block;
        margin: 0;
    }

    .toc-wrapper {
        /* position: sticky; */
        /* top: 100px; 距离视口顶部 100px 开始固定 */
        /* max-height: calc(100vh - 120px); */
        /* overflow-y: auto; */
    }

    .toc-wrapper h3 {
        font-size: 1rem;
        font-weight: 600;
        margin-top: 0;
        margin-bottom: 1rem;
    }

    .toc-wrapper ul {
        list-style: none;
        padding-left: 0;
    }

    .toc-wrapper a {
        display: block;
        color: var(--secondary-text-color);
        text-decoration: none;
        padding: 6px 0;
        font-size: 0.875rem;
        border-left: 2px solid transparent;
        padding-left: 1rem;
        transition: all 0.2s ease;
    }

    .toc-wrapper a:hover {
        color: var(--primary-text-color);
        background-color: var(--primary-fill-color);
    }

    .toc-wrapper li.depth-3 a {
        padding-left: 2rem; /* h3 标题缩进 */
    }

    .toc-wrapper a.active {
        color: var(--accent-color);
        border-left-color: var(--accent-color);
    }

    /* --- 5. 响应式：在小屏幕上变为单栏 --- */
    @media (max-width: 1024px) {
        .post-layout-grid {
            grid-template-columns: 1fr; /* 变为单栏 */
        }

        .post-toc {
            /* display: none; 在移动端隐藏右侧目录 */
        }
    }

    /* ==========================================================================
   【修正版】文章内表格样式美化 (使用 :global 穿透作用域)
   ========================================================================== */

    /* 1. 表格整体容器 */
    .post-content :global(table) {
        width: 100%;
        border-collapse: collapse;
        margin: 2.5rem 0;
        /* font-size: 0.95rem; */
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        display: block; /* 某些极端情况下防止溢出，通常 table-layout: fixed 也行 */
        overflow-x: auto; /* 允许表格在极小屏幕下横向滚动 */
    }

    /* 2. 表头 (thead) 样式 */
    .post-content :global(thead tr) {
        background-color: var(--c-bg-card);
        border-bottom: 2px solid var(--border-color);
    }

    .post-content :global(th) {
        font-weight: 700;
        text-align: left;
        color: var(--primary-text-color);
    }

    /* 3. 单元格 (th 和 td) 通用样式 */
    .post-content :global(th),
    .post-content :global(td) {
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        word-break: break-word; /* 防止长单词撑破 */
    }

    /* 可选：去掉最外层边框，看起来更干净 */
    .post-content :global(table tr:first-child th),
    .post-content :global(table tr:first-child td) {
        border-top: none;
    }
    .post-content :global(table tr:last-child td) {
        border-bottom: none;
    }
    .post-content :global(table tr th:first-child),
    .post-content :global(table tr td:first-child) {
        border-left: none;
    }
    .post-content :global(table tr th:last-child),
    .post-content :global(table tr td:last-child) {
        border-right: none;
    }

    /* 4. 斑马纹 */
    .post-content :global(tbody tr:nth-child(even)) {
        background-color: rgba(0, 0, 0, 0.02); /* 极淡的灰色 */
    }

    /* 5. 悬停效果 */
    .post-content :global(tbody tr:hover) {
        background-color: rgba(0, 0, 0, 0.05);
        transition: background-color 0.2s ease;
    }

    /* ==========================================================================
   深色模式适配
   ========================================================================== */
    :global(html.dark) .post-content :global(table) {
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    :global(html.dark) .post-content :global(thead tr) {
        background-color: var(--c-code-bg); /* 深色模式下表头深一点 */
    }

    :global(html.dark) .post-content :global(tbody tr:nth-child(even)) {
        background-color: rgba(255, 255, 255, 0.03);
    }

    :global(html.dark) .post-content :global(tbody tr:hover) {
        background-color: rgba(255, 255, 255, 0.06);
    }

    /* ==========================================================================
   【新增】Mark 高亮标签美化
   ========================================================================== */

    .post-content :global(mark) {
        /* 1. 圆角 (核心需求)：使用你全局定义的 4px 圆角 */
        border-radius: var(--border-radius);

        /* 2. 内边距：让背景色向外扩一点，这样圆角才看得出来，也不会挤到文字 */
        padding: 0.1em 0.3em;
        margin: 0 0.1em; /* 左右稍微留点白 */

        /* 3. 背景色：
       这里推荐使用柔和的“复古黄”，配合你的 Journal 风格。
       不要用纯黄 (yellow)，太刺眼。
    */
        background-color: rgba(255, 215, 0, 0.25);

        /* 文字颜色保持继承，或者你可以强制设为深色 */
        color: inherit;

        /* 4. 其它优化 */
        vertical-align: baseline;
        -webkit-box-decoration-break: clone; /* 关键：如果高亮换行了，保证两行都有圆角 */
        box-decoration-break: clone;
    }

    /* 深色模式适配 */
    :global(html.dark) .post-content :global(mark) {
        /* 深色模式下，背景色需要更透明一点，或者稍微亮一点以便看清 */
        background-color: rgba(255, 215, 0, 0.15);
        color: var(--primary-text-color);
    }
</style>
