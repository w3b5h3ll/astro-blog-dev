---
import { getCollection } from "astro:content";
import type { GetStaticPaths } from "astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import BlogPost from "../../components/BlogPost.astro";

export const getStaticPaths: GetStaticPaths = async () => {
    // 1. 使用 getCollection 获取所有文章
    const allPosts = await getCollection("posts");
    allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

    // 2. 从 post.data.tags 获取标签
    const uniqueTags = [...new Set(allPosts.map((post) => post.data.tags).flat())];

    return uniqueTags.map((tag) => {
        // 如果 tag 不存在，直接返回，避免错误
        if (!tag) {
            return;
        }
        // 3. 同样，从 post.data.tags 过滤文章
        const filteredPosts = allPosts.filter((post) =>
            post.data.tags?.includes(tag)
        );
        return {
            params: { tag },
            props: { posts: filteredPosts },
        };
    });
};

const { tag } = Astro.params;
const { posts } = Astro.props;

---

<BaseLayout pageTitle={tag}>
    <h2>包含「{tag}」标签的文章</h2>
    <hr class="astro-hr" />
    <div class='archive-list'>
        {
            posts.map((post:any) => {
                const dateObject = new Date(post.data.pubDate);
                const formattedDate = dateObject.toLocaleDateString("zh-CN", {
                    month: "2-digit",
                    day: "2-digit",
                });
                return (
                    <article class='archive-item'>
                        <a href={`/posts/${post.slug}/`} class="archive-item-link">
                            {post.data.title}
                        </a>
                        <span class='archive-item-date'>{formattedDate}</span>
                    </article>
                );
            })
        }
    </div>
</BaseLayout>