---
import BaseLayout from "../layouts/BaseLayout.astro";
import thoughtsData from "../data/thoughts.js";
import PasswordPrompt from "../components/PasswordPrompt.jsx";
import CryptoJS from "crypto-js";

// é…ç½®é¡µé¢å…ƒæ•°æ®
const pageTitle = "Thoughts";
const { AES } = CryptoJS;

// é…ç½®å‚æ•°
const THREE_DAYS_MS = 3 * 24 * 60 * 60 * 1000;
// å»ºè®®è¿˜æ˜¯èµ°ç¯å¢ƒå˜é‡ï¼Œè¿™é‡Œä¸ºäº†æ¼”ç¤ºä¿ç•™ç¡¬ç¼–ç 
// const SECRET_KEY = import.meta.env.SECRET_PASSWORD;
const SECRET_KEY = "secret";
const now = new Date();

// 1. é¢„å¤„ç†æ•°æ®ï¼šå¢åŠ æ ¼å¼åŒ–åçš„æ—¥æœŸå­—æ®µ
const allThoughts = thoughtsData.map((item) => {
    const itemDate = new Date(item.date);
    return {
        ...item,
        dateObj: itemDate,
        dateStr:
            itemDate.toLocaleDateString("en-CA") +
            " " +
            itemDate.toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
            }),
        timestamp: itemDate.getTime(),
    };
});

// 2. æŒ‰æ—¶é—´å€’åºæ’åº
allThoughts.sort((a, b) => b.timestamp - a.timestamp);

// 3. åˆ†ç¦»æ•°æ®ï¼šæ˜æ–‡åŒº vs åŠ å¯†åŒº
const recentThoughts = [];
const expiredThoughts = [];

allThoughts.forEach((item) => {
    if (now.getTime() - item.timestamp > THREE_DAYS_MS) {
        expiredThoughts.push(item);
    } else {
        recentThoughts.push(item);
    }
});

// 4. å¤„ç†åŠ å¯†åŒºï¼šå°†è¿‡æœŸæ•°æ®æ‹¼æ¥ä¸º HTML å­—ç¬¦ä¸²ï¼Œç„¶åæ•´ä½“åŠ å¯†
// è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨æ„å»ºä¸ä¸‹æ–¹ Astro æ¨¡æ¿ä¸€è‡´çš„ HTML ç»“æ„
let encryptedBlock = null;

if (expiredThoughts.length > 0 && SECRET_KEY) {
    const expiredHtml = expiredThoughts
        .map(
            (item) => `
        <div class="thought-card expired-item">
            <div class="thought-meta">
                <time>${item.dateStr}</time>
                <span class="lock-icon" style="font-size:0.75em; opacity:0.7;">ğŸ”“ Restored</span>
            </div>
            <div class="thought-content">
                <p>${item.content}</p>
            </div>
        </div>
    `
        )
        .join(""); // å°†æ‰€æœ‰è¿‡æœŸå¡ç‰‡æ‹¼æ¥åœ¨ä¸€èµ·

    encryptedBlock = AES.encrypt(expiredHtml, SECRET_KEY).toString();
}
---

<BaseLayout pageTitle={pageTitle}>
    <div class='post-layout-grid thoughts-layout'>
        <header class='post-header'>
            <h1>{pageTitle}</h1>
            <div class='post-meta'>
                <span>Capture fleeting ideas.</span>
                <span>3æ—¥å¯è§</span>
            </div>
        </header>

        <div class='thoughts-list prose prose-slate dark:prose-invert mx-auto'>
            {/* ç¬¬ä¸€éƒ¨åˆ†ï¼šæ˜¾ç¤º 3 å¤©å†…çš„å†…å®¹ (æ˜æ–‡) */}
            {
                recentThoughts.map((item) => (
                    <div class='thought-card'>
                        <div class='thought-meta'>
                            <time>{item.dateStr}</time>
                            <span class='fresh-icon'>âœ¨ New</span>
                        </div>
                        <div class='thought-content'>
                            <p>{item.content}</p>
                        </div>
                    </div>
                ))
            }

            {/* ç¬¬äºŒéƒ¨åˆ†ï¼šæ˜¾ç¤ºåˆ†å‰²çº¿å’ŒåŠ å¯†æ¡† (å¦‚æœå­˜åœ¨è¿‡æœŸå†…å®¹) */}
            {
                encryptedBlock && (
                    <div class='archive-section'>
                        <div class='archive-divider'>
                            <span>
                                Expired Thoughts ({expiredThoughts.length})
                            </span>
                        </div>

                        <div class='password-wrapper'>
                            <div class='archive-intro'>
                                ä¸‹æ–¹å†…å®¹å·²å°å­˜ï¼Œè¯·è¾“å…¥å¯†é’¥æŸ¥çœ‹å†å²çµæ„Ÿã€‚
                            </div>
                            {/* è¿™é‡Œçš„ç»„ä»¶è§£å¯†åï¼Œä¼šæŠŠä¸Šé¢çš„ expiredHtml æ¸²æŸ“å‡ºæ¥ */}
                            <PasswordPrompt
                                client:visible
                                encryptedContent={encryptedBlock}
                                correctPassword={SECRET_KEY}
                            />
                        </div>
                    </div>
                )
            }
        </div>
    </div>
</BaseLayout>

<style>
    .post-layout-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0;
        width: 100%;
        max-width: 100%;
        min-width: 0;
    }

    .post-header {
        padding-bottom: 2rem;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 2rem;
    }

    .post-meta {
        display: flex;
        gap: 1.5rem;
        font-size: 0.9rem;
        color: var(--secondary-text-color);
    }

    .thoughts-list {
        width: 100%;
        max-width: 100%;
    }

    /* --- å¡ç‰‡æ ·å¼ --- */
    /* æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº† :global() å› ä¸ºè§£å¯†åçš„ HTML æ˜¯åŠ¨æ€æ’å…¥çš„ */
    /* è¿™æ ·å¯ä»¥ç¡®ä¿è§£å¯†å‡ºæ¥çš„ div ä¹Ÿèƒ½åƒåˆ°æ ·å¼ */
    :global(.thought-card) {
        padding: 0 0 2rem 1.5rem;
        border-left: 2px solid var(--border-color);
        position: relative;
        margin-bottom: 0;
        animation: fadeIn 0.5s ease-in-out;
    }

    /* æ—¶é—´è½´å°åœ†ç‚¹ */
    :global(.thought-card::before) {
        content: "";
        position: absolute;
        left: -6px;
        top: 0.35rem; /* å¾®è°ƒå¯¹é½æ—¥æœŸ */
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--border-color);
        transition: background-color 0.3s ease;
    }

    :global(.thought-card:hover::before) {
        background: var(--accent-color, #3b82f6);
    }

    /* é’ˆå¯¹è¿‡æœŸå†…å®¹çš„ç‰¹æ®Šæ ·å¼ï¼ˆå˜ç°ä¸€ç‚¹ï¼Œä½“ç°å†å²æ„Ÿï¼‰ */
    :global(.thought-card.expired-item) {
        opacity: 0.85;
    }
    :global(.thought-card.expired-item::before) {
        background: var(--border-color); /* ä¿æŒç°è‰² */
    }

    :global(.thought-meta) {
        font-size: 0.85rem;
        color: var(--secondary-text-color);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .fresh-icon {
        color: var(--accent-color, #3b82f6);
        font-size: 0.75rem;
        font-weight: bold;
    }

    :global(.thought-content p) {
        margin-top: 0;
        margin-bottom: 0.5rem;
        line-height: 1.7;
    }

    /* --- å½’æ¡£åŒºåŸŸæ ·å¼ --- */
    .archive-section {
        margin-top: 2rem;
    }

    .archive-divider {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        color: var(--secondary-text-color);
        font-size: 0.85rem;
    }

    .archive-divider::before,
    .archive-divider::after {
        content: "";
        flex: 1;
        border-bottom: 1px dashed var(--border-color);
    }

    .archive-divider span {
        padding: 0 1rem;
    }

    .archive-intro {
        font-size: 0.9rem;
        color: var(--secondary-text-color);
        margin-bottom: 1rem;
        text-align: center;
    }

    .password-wrapper {
        padding: 2rem 1rem;
        background: var(--c-bg-card, rgba(0, 0, 0, 0.02));
        border-radius: var(--border-radius, 4px);
        border: 1px dashed var(--border-color);
        text-align: center; /* è®©å¯†ç æ¡†å±…ä¸­ */
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
